# UGC AI App - R√®gles pour Cursor/Claude

## üö® AVANT DE MODIFIER UNE FEATURE

1. **Consulter la documentation** dans `/docs/` :
   - `CRITICAL_BEHAVIORS.md` - Invariants √† NE JAMAIS casser
   - `ARCHITECTURE.md` - Vue d'ensemble
   - `DATABASE.md` - Sch√©ma BDD
   - `FEATURES.md` - Documentation fonctionnelle

2. Si la doc n'existe pas pour cette feature ‚Üí **la cr√©er AVANT de coder**

3. Apr√®s avoir √©tabli un nouveau comportement critique ‚Üí **l'ajouter √† CRITICAL_BEHAVIORS.md**

## ‚ùå NE JAMAIS FAIRE

### Base de donn√©es
- Utiliser `.single()` sur `campaign_clips` filtr√© par `order` (plusieurs clips possibles par beat)
- √âcraser `video.raw_url` ou `video.final_url` si elles existent d√©j√†
- Oublier de g√©rer `is_selected` pour le versioning des clips
- Oublier le cast `as any` sur les requ√™tes Supabase (voir section Supabase ci-dessous)

### Vid√©o / Audio
- Ralentir les vid√©os (speed < 1.0) - UGC TikTok = toujours >= 1.0
- Superposer l'audio au lieu de le remplacer dans le mix
- Resize avant concat (cause INTERNAL_COMMAND_ERROR)
- Utiliser fal.ai compose pour le concat (timestamps cass√©s)

### FFmpeg
- Oublier `setpts=PTS-STARTPTS` avant le trim
- Utiliser `igndts` flag (coupe le d√©but des vid√©os)
- Oublier `trim=start=0` explicite pour les vid√©os Veo

### Code
- Cr√©er des fichiers sans justification - modifier l'existant d'abord
- Mettre des instructions n√©gatives dans les prompts Claude ("don't use X accent")
- Utiliser l'index au lieu de clip.id pour les ajustements
- Utiliser un index de boucle (ex: `uniqueBeats[index]`) pour identifier un clip dans un autre tableau (ex: `generatedClips`) - les ordres peuvent diff√©rer ! Toujours utiliser `clip.id` ou `clip.order`

### Modifications UI (tous composants React)
- Modifier les `onClick`, `disabled`, `value`, `onChange` - c'est la logique m√©tier
- Supprimer ou modifier les conditions `{loading && ...}`, `{error && ...}`
- Changer la structure des `.map()` ou les `key={...}`
- Toucher aux useEffect ou callbacks m√©tier
- Voir **section 15 de CRITICAL_BEHAVIORS.md** pour les r√®gles d√©taill√©es

## ‚úÖ TOUJOURS FAIRE

### Versioning clips
- Utiliser `getEffectiveAdjustments()` pour obtenir trim/speed (auto vs user)
- Pr√©server les vid√©os existantes lors de la sauvegarde en step5
- Garder un seul clip avec `is_selected=true` par beat
- Archiver la version APR√àS la r√©g√©n√©ration r√©ussie (pas avant)

### FFmpeg / Transloadit
- Normaliser les timestamps FFmpeg avant concat (`setpts=PTS-STARTPTS`)
- Forcer r√©-encodage dans concat (preset: 'ipad-high')
- Resize 9:16 dans une √©tape S√âPAR√âE apr√®s concat
- Retry automatique (3x) pour les assemblages

### Documentation
- Documenter les nouveaux comportements critiques
- Mettre √† jour CRITICAL_BEHAVIORS.md apr√®s un fix de bug majeur
- Inclure le commit de r√©f√©rence dans la doc

### Modifications UI (tous composants React) - CE QUI EST SAFE
- Modifier uniquement les `className` (Tailwind)
- Changer les constantes de style (`BEAT_COLORS`, `BEAT_LABELS`, etc.)
- Modifier les textes/labels affich√©s
- Changer les ic√¥nes (Lucide) sans modifier les props fonctionnels
- Ajuster le layout (grid/flex) SANS toucher aux .map() ou key
- Modifier les composants UI isol√©s (sans logique m√©tier)
- Tester apr√®s chaque modification !

### Supabase TypeScript
- TOUJOURS utiliser `(supabase.from('table') as any)` pour `.update()` et `.insert()`
- Sans ce cast, erreur au build : "Argument of type is not assignable to parameter of type 'never'"
- Exemple correct :
  ```typescript
  const { error } = await (supabase
    .from('campaign_clips') as any)
    .update({ video: { ...clip.video, prompt: newPrompt } })
    .eq('id', clipId)
  ```

## üìÅ Fichiers importants

### Types et config
- `types/index.ts` - Tous les types TypeScript
- `lib/presets.ts` - D√©finition des presets (intentions)
- `lib/admin.ts` - Liste des admins

### G√©n√©ration principale
- `components/steps/step6-generate.tsx` - Logique de g√©n√©ration
- `components/steps/step5-plan.tsx` - G√©n√©ration du plan
- `lib/api/claude.ts` - Prompts et g√©n√©ration de plans

### Endpoints API critiques
- `app/api/generate/process-clip/route.ts` - Trim + Speed (Transloadit)
- `app/api/assemble/route.ts` - Concat final (Transloadit)
- `app/api/generate/mix-video/route.ts` - Mix audio

### Hooks
- `hooks/use-video-generation.ts` - Logique de g√©n√©ration
- `hooks/use-credits.ts` - Gestion des cr√©dits

## üîë IDs importants

- Supabase Project ID : `xresijptcptdilwecklf`
- Cloudinary Cloud Name : `dap13uqjz`

## üìä Mapping Beats ‚Üí Order

| Order | Beat | Description |
|-------|------|-------------|
| 1 | hook | Accroche |
| 2 | problem | Probl√®me (ou agitation) |
| 3 | solution | Solution |
| 4 | proof | Preuve |
| 5 | cta | Call-to-action |

## üí∞ Syst√®me de cr√©dits

- **1 cr√©dit = 1 centime d'euro**
- Balance en cr√©dits (pas en centimes)
- Balance peut √™tre n√©gative (race condition protection)

## üó£Ô∏è Communication

- Toujours r√©pondre en fran√ßais
- Ne pas cr√©er de nouveaux fichiers sans demander
- Modifier l'existant plut√¥t que cr√©er du nouveau
- Citer les commits de r√©f√©rence quand pertinent

## üìä Structure des ajustements (V2)

```typescript
// Auto (Whisper + Claude)
interface AutoAdjustments {
  trim_start: number;
  trim_end: number;
  speed: number;
  updated_at: string;  // CRITIQUE pour priorit√©
}

// User (slider UI)
interface UserAdjustments {
  trim_start: number;
  trim_end: number;
  speed: number;
  updated_at: string;  // CRITIQUE pour priorit√©
}

// R√®gle : user > auto SI user.updated_at > auto.updated_at
```

## üé¨ Pipeline vid√©o

```
First Frame ‚Üí Vid√©o (Veo) ‚Üí Transcription ‚Üí Voice Clone ‚Üí Ambient ‚Üí Mix ‚Üí Process ‚Üí Assemble
```

Chaque √©tape a ses propres r√®gles - voir `docs/CRITICAL_BEHAVIORS.md`
