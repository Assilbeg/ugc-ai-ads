# I18N / Multilingue

Objectif : UI multilingue (fr défaut) avec routing par segment locale (`/fr/...`, `/en/...`, etc.) et chargement des messages via **next-intl**.

## Stack et conventions

- Lib : `next-intl` (App Router).
- Locales UI supportées : `fr`, `en`, `es`, `de`, `it`, `pt`, `nl`.
- Locale par défaut : `fr`.
- Mapping UI → `CampaignBrief.language` (script) :
  - `fr` → `fr`
  - `en` → `en-us`
  - `es` → `es`
  - `de` → `de`
  - `it` → `it`
  - `pt` → `pt-br`
  - `nl` → `nl`
- Les API restent hors segment locale (`/api/...` inchangé).
- Les pages publiques/privées sont sous `app/[locale]/...`.

## Routing / layouts

- `app/layout.tsx` : minimal (pas de `<html>`), délègue au layout localisé.
- `app/[locale]/layout.tsx` : charge les polices, `globals.css`, appelle `NextIntlClientProvider`, set `<html lang={locale}>`.
- `app/page.tsx` : redirige vers `/${defaultLocale}`.
- `app/[locale]/page.tsx` : redirige l’utilisateur vers `/${locale}/dashboard` ou `/${locale}/login` selon la session Supabase.
- Route groups conservés : `(auth)`, `(dashboard)`, `(admin)` sous `app/[locale]/`.

## Messages

- Fichier de référence : `messages/fr.json`.
- Autres locales : même structure, traduction future.
- Nommage conseillé : espaces de noms (`common`, `auth`, `dashboard`, `steps`, `step1` …).
- Les clés doivent rester stables ; éviter d’encoder des phrases entières dans les composants.

## Middleware

- `next-intl` middleware avec `localePrefix: 'always'` (toutes les URLs incluent la locale).
- Combiner avec middleware Supabase (auth) :
  - Ignorer `/api`, `/_next`, assets.
  - Extraire la locale du pathname, sinon fallback `defaultLocale`.
  - Redirections auth doivent préfixer la locale (`/${locale}/login`, `/${locale}/dashboard`).
  - Les cookies Supabase doivent être propagés sur la réponse finale.

## Bonnes pratiques de migration

- Toujours utiliser `useTranslations`/`getTranslations` au lieu de texte en dur.
- Ne pas toucher la logique métier (voir `CRITICAL_BEHAVIORS.md` section UI).
- Mettre à jour les `Link`/`router.push` pour conserver la locale (`/${locale}/...`), éviter de perdre la langue choisie.
- Pour les composants client qui redirigent (ex: logout), récupérer la locale via `useLocale()`.
- Préparer les constantes traduisibles (labels, options, statuts) dans les fichiers de messages plutôt que dans le code.

## Ordre de livraison (résumé du plan)

1. **Infra** : installer `next-intl`, créer `i18n/config.ts` + `i18n/request.ts`, structure `messages/fr.json`, layout localisé, middleware combiné.
2. **UI** : Locale switcher + `useLocaleSync` (brief.language).
3. **Migration progressive** : login/register → dashboard → steps 1-6 (labels uniquement).
4. **SEO** : metadata localisées + `hreflang`.
5. **Docs & règles** : mettre à jour `.cursorrules` si de nouvelles contraintes i18n sont ajoutées.

## Avancement (janv 2026)

- Step4 : formulaires + overlays génération localisés (text-only).
- Step5 : prompts visuels + CTA navigation/génération localisés (logique intacte).
- Step6 : actions, statuts, beats, erreurs (crédits/génération/assemblage), modal d’assemblage localisés (text-only).
- Dashboard admin : titres, stats, quick actions, solde Fal.ai localisés.
- Pages admin détaillées (actors/presets/prompts/billing/logs) : laissées en français (admin only, faible priorité).
- Logs/console debug Step6 conservés en FR (non visibles UI).

Objectif : UI multilingue (fr défaut) avec routing par segment locale (`/fr/...`, `/en/...`, etc.) et chargement des messages via **next-intl**.

## Stack et conventions

- Lib : `next-intl` (App Router).
- Locales UI supportées : `fr`, `en`, `es`, `de`, `it`, `pt`, `nl`.
- Locale par défaut : `fr`.
- Mapping UI → `CampaignBrief.language` (script) :
  - `fr` → `fr`
  - `en` → `en-us`
  - `es` → `es`
  - `de` → `de`
  - `it` → `it`
  - `pt` → `pt-br`
  - `nl` → `nl`
- Les API restent hors segment locale (`/api/...` inchangé).
- Les pages publiques/privées sont sous `app/[locale]/...`.

## Routing / layouts

- `app/layout.tsx` : minimal (pas de `<html>`), délègue au layout localisé.
- `app/[locale]/layout.tsx` : charge les polices, `globals.css`, appelle `NextIntlClientProvider`, set `<html lang={locale}>`.
- `app/page.tsx` : redirige vers `/${defaultLocale}`.
- `app/[locale]/page.tsx` : redirige l’utilisateur vers `/${locale}/dashboard` ou `/${locale}/login` selon la session Supabase.
- Route groups conservés : `(auth)`, `(dashboard)`, `(admin)` sous `app/[locale]/`.

## Messages

- Fichier de référence : `messages/fr.json`.
- Autres locales : même structure, traduction future.
- Nommage conseillé : espaces de noms (`common`, `auth`, `dashboard`, `steps`, `step1` …).
- Les clés doivent rester stables ; éviter d’encoder des phrases entières dans les composants.

## Middleware

- `next-intl` middleware avec `localePrefix: 'always'` (toutes les URLs incluent la locale).
- Combiner avec middleware Supabase (auth) :
  - Ignorer `/api`, `/_next`, assets.
  - Extraire la locale du pathname, sinon fallback `defaultLocale`.
  - Redirections auth doivent préfixer la locale (`/${locale}/login`, `/${locale}/dashboard`).
  - Les cookies Supabase doivent être propagés sur la réponse finale.

## Bonnes pratiques de migration

- Toujours utiliser `useTranslations`/`getTranslations` au lieu de texte en dur.
- Ne pas toucher la logique métier (voir `CRITICAL_BEHAVIORS.md` section UI).
- Mettre à jour les `Link`/`router.push` pour conserver la locale (`/${locale}/...`), éviter de perdre la langue choisie.
- Pour les composants client qui redirigent (ex: logout), récupérer la locale via `useLocale()`.
- Préparer les constantes traduisibles (labels, options, statuts) dans les fichiers de messages plutôt que dans le code.

## Ordre de livraison (résumé du plan)

1. **Infra** : installer `next-intl`, créer `i18n/config.ts` + `i18n/request.ts`, structure `messages/fr.json`, layout localisé, middleware combiné.
2. **UI** : Locale switcher + `useLocaleSync` (brief.language).
3. **Migration progressive** : login/register → dashboard → steps 1-6 (labels uniquement).
4. **SEO** : metadata localisées + `hreflang`.
5. **Docs & règles** : mettre à jour `.cursorrules` si de nouvelles contraintes i18n sont ajoutées.
